<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BattleShip</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js" integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            margin: 0px;
            font-family: 'Inter', sans-serif;
        }

        .block {
            border: 1px solid gray;
            width: 40px;
            height: 40px;
        }


        .block-2 {
            border: 1px solid gray;
            width: 40px;
            height: 40px;
        }

        .block-2:hover {
            background: rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .nav {
            width: 100%;
            height: 70px;
            border-bottom: 1px solid rgb(228, 228, 228);
        }

        .playersOnline {
            float: right;
            margin-right: 50px;
            margin-top: 25px;
        }

        .icon {
            margin-left: 50px;
            position: absolute;
            margin-top: 21px;
            font-weight: bold;
            font-size: 23px;

        }

        .boards {
            display: flex;
            width: 1000px;
            position: absolute;
            margin-left: -500px;
            left: 50%;
            margin-top: 125px;
            opacity: 0.2;
        }

        #board {
        }

        #opponentBoard {
            margin-left: 200px;
        }
        
        .actions {
            width: 1000px;
            margin-left: -500px;
            left: 50%;
            position: absolute;
            display: flex;
        }

        .btn {
            padding: 10px 20px 10px 20px;
            font-size: 15px;
            cursor: pointer;
            outline: none;
            border: none;
            box-shadow: 0px 0px 2px 1px rgba(0,0,0,0.1);
            border-radius: 5px;
            color: white;
            background: rgb(0, 123, 255);
            margin-left: 50%;
            transform: translateX(-50%);
            margin-top: 40px;
        }

        .actionSection {
            width: 400px;
            height: 100px;
        }

        .actionSection:nth-of-type(2) {
            margin-left: 200px;
        }

        .input {
            width: 200px;
            margin: 0px;
        }

        .joinBtn {
            margin: 0px;
        }

        .gameIdContainer {
            
        }

        .gameId {
            text-align: center;
            margin-top: 39px;
        }

        #copy-svg {
            cursor: pointer;
            margin-top: 7px;
            margin-left: 10px;
            width: 26px;
            height: 26px;
        }

        #gameIdPlaceholder {position: absolute;opacity: 0;}

    </style>
</head>
<body>
    <div class="nav">
        <p id="playerOnline" class="playersOnline"></p>
        <p class="icon">BattleShip</p>
    </div>
    <main>
        <ul id="messages"></ul>
        <div class="actions">
            <div class="actionSection">
                <button id="createGame" class="btn">Create game</button>
                <h1 id="gameId" class="gameId"></h1>
                <input id="gameIdPlaceholder"></input>
            </div>
            <div class="actionSection">
                <input placeholder="#xxxxxx" class="input" id="gameIdInput">
                <button id="joinGame" class="joinBtn">Join game</button>
            </div>
        </div>
        <div class="boards">
            <div id="board" style="width: 400px; height: 400px;">
                    
            </div>
            <div id="opponentBoard" style="width: 400px; height: 400px;">
                
            </div>
        </div>
    </main>     
    
    <script>
        let currentGame;
        let uuid;
        const socket = io();

        socket.on('playersOnlineUpdate', (playerCount) => {
                if (playerCount == 0) {
                    document.getElementById('playerOnline').innerHTML = playerCount + " Player Online"
                } else {
                    document.getElementById('playerOnline').innerHTML = playerCount + " Players Online"
                }
        })
        socket.emit('requestPlayerCount', 0)

        document.addEventListener('DOMContentLoaded', () => {
            
            makeUUID();
            const gameId = document.getElementById('gameId');
            const createGame = document.getElementById('createGame');
            const joinGame = document.getElementById('joinGame');
            const input = document.getElementById('gameIdInput');
            const messages = document.getElementById('messages');

            createGame.addEventListener('click', () => {
                socket.emit('requestGame', [getUUID(), getShips()])
                document.getElementById("createGame").style.display = "none"

            })

            joinGame.addEventListener('click', () => {
                if (input.value != "") {
                    socket.emit("joinGame", [input.value, getUUID(), getShips()])
                    input.value = ""
                }
            })

            socket.on('moveSuccess', (data) => {
                if (data.game == getCurrentGame()) {
                    document.getElementById('oBlock-'+data.move).style.background = "black"
                    document.getElementById('opponentBoard').style.opacity = '0.3'
                }
            })

            socket.on('gameId', (msg) => {
                gameId.innerHTML = "#"+msg + `<svg id="copy-svg" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>`
                document.getElementById('gameIdPlaceholder').value = msg

                document.getElementById('copy-svg').addEventListener('click', () => {
                    document.getElementById('gameIdPlaceholder').select()
                    document.getElementById('gameIdPlaceholder').setSelectionRange(0, 99999);
                    navigator.clipboard.writeText(document.getElementById('gameIdPlaceholder').value);
                })
            })

            socket.on('gameJoinedID', (msg) => {
                setCurrentGame(msg[0])
                document.querySelector('.boards').style.opacity = 1
                if (msg[1] != getUUID()) {
                    document.getElementById('opponentBoard').style.opacity = '0.3'
                }
            })

            socket.on('yourGameJoined', (msg) => {
                if (msg[1] == getUUID()) {
                    console.log(msg[0])
                    setCurrentGame(msg[0])
                    document.querySelector('.boards').style.opacity = 1
                    if (msg[2] != getUUID()) {
                        document.getElementById('opponentBoard').style.opacity = '0.3'
                    }
                }
            })

            socket.on('opponentMove2', (move) => {
                console.log(move)
                if (move[0] == getCurrentGame()) {
                    console.log(move)
                    if (move[1] == getUUID()) {
                        document.getElementById("block-"+move[2]).style.background = "red"
                        if (move[3] == false) {
                            document.getElementById('opponentBoard').style.opacity = '1'
                        }
                    }
                }
            })

            socket.on('opponentMove1', (move) => {
                console.log(move)
                if (move[0] == getCurrentGame()) {
                    console.log(move)
                    if (move[1] == getUUID()) {
                        document.getElementById("block-"+move[2]).style.background = "red"
                        if (move[3] == false) {
                            document.getElementById('opponentBoard').style.opacity = '1'
                        }
                    }
                }
            })

            socket.on('hitTrue', (data) => {
                if (data[1] == getUUID()) {
                    document.getElementById("oBlock-"+data[2]).style.background = "orange"
                    document.getElementById('opponentBoard').style.opacity = '1'
                }
            })

            socket.on('gameEnded', (data) => {
                if (data.game == getCurrentGame()) {
                    if (data.winner == getUUID()) {
                        window.alert("You Won")
                        endGame();
                    }
                    if (data.loser == getUUID()) {
                        window.alert("You Lost")
                        endGame();
                    }
                }
            })




            // socket.on('chat message', (msg) => {
            //     const item = document.createElement('li');
            //     item.textContent = msg;
            //     console.log(msg)
            //     messages.appendChild(item);
            //     window.scrollTo(0, document.body.scrollHeight);
            // }); 

        })


    </script>

    <script>

        const board = document.getElementById('board')
        const opponentBoard = document.getElementById('opponentBoard')
        let ships = []

        function createBoard() {
            let x = 0;
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('div')
                row.style.display = "flex";
                board.appendChild(row)
                for (let i = 0; i < 10; i++) {
                    x++;
                    row.innerHTML = row.innerHTML + `<div class='block' id='block-${x}'></div>`
                }

            }
        }

        function createOpponentBoard() {
            let x = 0;
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('div')
                row.style.display = "flex";
                opponentBoard.appendChild(row)
                for (let i = 0; i < 10; i++) {
                    x++;
                    row.innerHTML = row.innerHTML + `<div class='block-2' id='oBlock-${x}' onClick="attack('${x}')"></div>`
                }

            }
        }

        createBoard()
        createOpponentBoard()


        function attack(x) {
            if (getCurrentGame() != undefined) {
                socket.emit('makeMove',[x, getCurrentGame(), getUUID()])
                
            }
        }   

        function getUUID() {
            return uuid;
        }

        function makeUUID() {
            const UUID = Math.floor(Math.random() * 10000000000)
            uuid = UUID;
        }

        function setCurrentGame(id) {
            currentGame = id
        }

        function getCurrentGame() {
            return currentGame;
        }

        function generateRandomShips() {
            for (let i = 0; i < 20; i++) {
                let randomU;
                let x = true;
                while (x == true) {
                    randomU = Math.floor(Math.random()*100)+1; 
                    if (document.getElementById('block-'+randomU).style.background != "gray") {x = false;}
                }
                
                placeShip(randomU) 
            }
        }

        function placeShip(i) {
            document.getElementById('block-'+i).style.background = "gray"
            ships.push(i)
        }
        function getShips() {
            return ships;
        }

        function endGame() {
            currentGame = undefined
        }

        generateRandomShips();

    </script>
</body>
</html>