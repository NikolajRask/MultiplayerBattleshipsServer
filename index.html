<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js" integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            margin: 0px;
        }

        .block {
            border: 1px solid gray;
            width: 40px;
            height: 40px;
        }

        .block:hover {
            background: rgba(0,0,0,0.1);
            cursor: pointer;
        }


        .block-2 {
            border: 1px solid gray;
            width: 40px;
            height: 40px;
        }

        .block-2:hover {
            background: rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .nav {
            width: 100%;
            height: 70px;
            border-bottom: 1px solid rgb(228, 228, 228);
        }

        .playersOnline {
            font-family: Arial, Helvetica, sans-serif;
            float: right;
            margin-right: 50px;
            margin-top: 27px;
        }

        .icon {
            margin-left: 50px;
            position: absolute;
            margin-top: 23px;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            font-size: 23px;

        }

        .boards {
            display: flex;
            width: 1000px;
            position: absolute;
            margin-left: -500px;
            left: 50%;
            margin-top: 125px;
        }

        #board {
        }

        #opponentBoard {
            margin-left: 200px;
        }
        
        .actions {
            width: 1000px;
            margin-left: -500px;
            left: 50%;
            position: absolute;
            display: flex;
        }

        .btn {
            padding: 10px 20px 10px 20px;
            font-size: 15px;
            cursor: pointer;
            outline: none;
            border: none;
            box-shadow: 0px 0px 2px 1px rgba(0,0,0,0.1);
            border-radius: 5px;
            color: white;
            background: rgb(0, 123, 255);
            
        }

        .actionSection {
            width: 400px;
            height: 100px;
        }

        .actionSection:nth-of-type(2) {
            margin-left: 200px;
        }

    </style>
</head>
<body>
    <div class="nav">
        <p id="playerOnline" class="playersOnline"></p>
        <p class="icon">BattleShips</p>
    </div>
    <main>
        <ul id="messages"></ul>
        <div class="actions">
            <div class="actionSection">
                <button id="createGame" class="btn">Create game</button>
                <h1 id="gameId"></h1>
            </div>
            <div class="actionSection">
                <input placeholder="#xxxxxx" id="gameIdInput">
                <button id="joinGame">Join game</button>
            </div>
        </div>
        <div class="boards">
            <div id="board" style="width: 400px; height: 400px;">
                    
            </div>
            <div id="opponentBoard" style="width: 400px; height: 400px;">
                
            </div>
        </div>
    </main>     
    
    <script>
        let currentGame;
        let uuid;
        const socket = io();

        socket.on('playersOnlineUpdate', (playerCount) => {
                console.log("e")
                document.getElementById('playerOnline').innerHTML = playerCount + " Players Online"
        })
        socket.emit('requestPlayerCount', 0)

        document.addEventListener('DOMContentLoaded', () => {
            
            makeUUID();
            const gameId = document.getElementById('gameId');
            const createGame = document.getElementById('createGame');
            const joinGame = document.getElementById('joinGame');
            const input = document.getElementById('gameIdInput');
            const messages = document.getElementById('messages');

            // form.addEventListener('submit', (e) => {
            //     e.preventDefault();
            //     if (input.value) {
            //         socket.emit('chat message', input.value);
            //         input.value = '';
            //     }
            // });
            createGame.addEventListener('click', () => {
                socket.emit('requestGame', [getUUID(), getShips()])
            })

            joinGame.addEventListener('click', () => {
                if (input.value != "") {
                    socket.emit("joinGame", [input.value, getUUID(), getShips()])
                    input.value = ""
                }
            })

            socket.on('gameId', (msg) => {
                gameId.innerHTML = "#"+msg
            })

            socket.on('gameJoinedID', (msg) => {
                setCurrentGame(msg)

            })

            socket.on('yourGameJoined', (msg) => {
                if (msg[1] == getUUID()) {
                    console.log(msg[0])
                    setCurrentGame(msg[0])
                }
            })

            socket.on('opponentMove2', (move) => {
                console.log(move)
                if (move[0] == getCurrentGame()) {
                    if (move[1] == getUUID()) {
                    document.getElementById("block-"+move[2]).style.background = "red"
                }   
                }
            })

            socket.on('opponentMove1', (move) => {
                console.log(move)
                if (move[0] == getCurrentGame()) {
                    if (move[1] == getUUID()) {
                        document.getElementById("block-"+move[2]).style.background = "red"
                    }
                }
            })

            socket.on('hitTrue', (data) => {
                if (data[1] == getUUID()) {
                    document.getElementById("block-"+data[2]).style.background = "orange"
                }
            })


            // socket.on('chat message', (msg) => {
            //     const item = document.createElement('li');
            //     item.textContent = msg;
            //     console.log(msg)
            //     messages.appendChild(item);
            //     window.scrollTo(0, document.body.scrollHeight);
            // }); 

        })


    </script>

    <script>

        const board = document.getElementById('board')
        const opponentBoard = document.getElementById('opponentBoard')
        let ships = []

        function createBoard() {
            let x = 0;
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('div')
                row.style.display = "flex";
                board.appendChild(row)
                for (let i = 0; i < 10; i++) {
                    x++;
                    row.innerHTML = row.innerHTML + `<div class='block' id='block-${x}' onClick="attack('${x}')"></div>`
                }

            }
        }

        function createOpponentBoard() {
            let x = 0;
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('div')
                row.style.display = "flex";
                opponentBoard.appendChild(row)
                for (let i = 0; i < 10; i++) {
                    x++;
                    row.innerHTML = row.innerHTML + `<div class='block-2' id='oBlock-${x}' onClick="attack('${x}')"></div>`
                }

            }
        }

        createBoard()
        createOpponentBoard()


        function attack(x) {
            if (getCurrentGame() != undefined) {
                socket.emit('makeMove',[x, getCurrentGame(), getUUID()])
                document.getElementById("block-"+x).style.background = "blue"
            }
        }   

        function getUUID() {
            return uuid;
        }

        function makeUUID() {
            const UUID = Math.floor(Math.random() * 10000000000)
            uuid = UUID;
        }

        function setCurrentGame(id) {
            currentGame = id
        }

        function getCurrentGame() {
            return currentGame;
        }

        function generateRandomShips() {
            for (let i = 0; i < 20; i++) {
                let randomU;
                let x = true;
                while (x == true) {
                    randomU = Math.floor(Math.random()*100)+1; 
                    if (document.getElementById('block-'+randomU).style.background != "gray") {x = false;}
                }
                
                placeShip(randomU) 
            }
        }

        function placeShip(i) {
            document.getElementById('block-'+i).style.background = "gray"
            ships.push(i)
        }
        function getShips() {
            return ships;
        }

        generateRandomShips();

    </script>
</body>
</html>